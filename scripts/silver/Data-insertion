-- fix crm_cust_info


insert into silver.crm_cust_info (
            cst_id, 
			cst_key, 
			cst_firstname, 
			cst_lastname, 
			cst_marital_status, 
			cst_gndr,
			cst_create_date)
			(select 
cst_id,
cst_key,
TRIM(cst_firstname) as cst_firstname,
TRIM(cst_lastname) as cst_lastname,
case
when UPPER(trim(cst_marital_status)) = 'M' then 'Married'
when UPPER(trim(cst_marital_status)) = 'S' then 'Single'
else 'n/a'
end  as cst_marital_status,
case
when UPPER(trim(cst_gndr)) = 'M' then 'Male'
when UPPER(trim(cst_gndr)) = 'F' then 'Female'
else 'n/a'
end  as cst_gndr,
cst_create_date
from
(select *,ROW_NUMBER() over(partition by cst_id order by  cst_create_date desc) as rank 
from bronze.crm_cust_info) 
as t
where rank = 1 and cst_id is not null);



-- inseritng crm_prd_info


-- The IF and Go is use to check the table silver.crm_prd_info is creared or not  if it present the drop it Else Create new table because while cleaning the product key is splited in is and product key 


IF OBJECT_ID('silver.crm_prd_info', 'U') IS NOT NULL
    DROP TABLE silver.crm_prd_info;
GO

CREATE TABLE silver.crm_prd_info (
    prd_id          INT,
    cat_id          NVARCHAR(50),
    prd_key         NVARCHAR(50),
    prd_nm          NVARCHAR(50),
    prd_cost        INT,
    prd_line        NVARCHAR(50),
    prd_start_dt    DATE,
    prd_end_dt      DATE,
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);

INSERT INTO silver.crm_prd_info (
			prd_id,
			cat_id,
			prd_key,
			prd_nm,
			prd_cost,
			prd_line,
			prd_start_dt,
			prd_end_dt
		)
		select 
prd_id,
replace(substring(prd_key,1,5),'-','_') as cat_id,
substring(prd_key,7,len(prd_key)) as prd_key,
prd_nm,
ISNULL(prd_cost,0) as prd_cost,
case 
WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain'
when UPPER(trim(prd_line)) = 'R' then 'Road'
when UPPER(trim(prd_line)) = 'S' then 'Other Sales'
when UPPER(trim(prd_line)) = 'T' then 'Touring'
else 'n/a'
end as prd_line,
cast(prd_start_dt as date) as prd_start_date,
cast(lead(prd_start_dt) over( partition by prd_key order by prd_start_dt)-1 as date) as prd_end_dt
from bronze.crm_prd_info



